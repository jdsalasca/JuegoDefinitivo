name: release

on:
  push:
    tags:
      - "v*"

jobs:
  build-desktop-release:
    runs-on: windows-latest
    permissions:
      contents: write
    env:
      APP_NAME: AutoBookQuest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: maven

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: apps/frontend/package-lock.json

      - name: Build frontend
        working-directory: apps/frontend
        run: |
          npm ci
          npm run build

      - name: Sync frontend assets to backend static
        shell: pwsh
        run: |
          Remove-Item -Recurse -Force "apps/backend/src/main/resources/static/*" -ErrorAction SilentlyContinue
          Copy-Item -Recurse -Force "apps/frontend/dist/*" "apps/backend/src/main/resources/static/"

      - name: Package backend jar
        working-directory: apps/backend
        run: mvn -B clean package -DskipTests

      - name: Build app image and zip
        id: package
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}".TrimStart('v')
          $jar = Get-ChildItem "apps/backend/target/autobook-adventure-*.jar" | Select-Object -First 1
          if (-not $jar) { throw "Jar no encontrado en apps/backend/target" }
          New-Item -ItemType Directory -Force -Path ".jpackage-input" | Out-Null
          Copy-Item $jar.FullName ".jpackage-input/$($jar.Name)" -Force
          New-Item -ItemType Directory -Force -Path "dist" | Out-Null
          jpackage `
            --type app-image `
            --name "$env:APP_NAME" `
            --dest "dist" `
            --input ".jpackage-input" `
            --main-jar "$($jar.Name)" `
            --main-class "org.springframework.boot.loader.launch.JarLauncher" `
            --app-version "$version" `
            --java-options "-Dserver.port=8080"
          Compress-Archive -Path "dist/$env:APP_NAME/*" -DestinationPath "dist/AutoBookQuest-win64.zip" -Force
          "zip_path=dist/AutoBookQuest-win64.zip" >> $env:GITHUB_OUTPUT

      - name: Create update manifest
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"
          $url = "https://github.com/${{ github.repository }}/releases/download/$tag/AutoBookQuest-win64.zip"
          $manifest = @{
            version = $tag
            publishedAt = (Get-Date).ToString("o")
            channel = "stable"
            assets = @(@{ platform = "win64"; url = $url })
          } | ConvertTo-Json -Depth 4
          Set-Content -Path "dist/latest.json" -Value $manifest -Encoding UTF8

      - name: Publish GitHub release assets
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            ${{ steps.package.outputs.zip_path }}
            dist/latest.json

